use crate::bus::Card;
use crate::mmu::Mmu;
use crate::video::Video;

/* Documentation of Videoterm
    See:
    - https://mirrors.apple2.org.za/Apple%20II%20Documentation%20Project/Interface%20Cards/80%20Column%20Cards/Videx%20Videoterm/Manuals/Videx%20Videoterm%20-%20Installation%20and%20Operation%20Manual.pdf
    - http://www.bitsavers.org/components/motorola/_dataSheets/6845.pdf
    - https://glasstty.com/?p=660
*/

#[cfg(feature = "serde_support")]
use serde::{Deserialize, Serialize};

#[cfg(feature = "web_time")]
use web_time::SystemTime;

#[cfg(not(feature = "web_time"))]
use std::time::SystemTime;

const ROM: [u8; 1024] = [
    0xad, 0x7b, 0x07, 0x29, 0xf8, 0xc9, 0x30, 0xf0, 0x21, 0xa9, 0x30, 0x8d, 0x7b, 0x07, 0x8d, 0xfb,
    0x07, 0xa9, 0x00, 0x8d, 0xfb, 0x06, 0x20, 0x61, 0xc9, 0xa2, 0x00, 0x8a, 0x8d, 0xb0, 0xc0, 0xbd,
    0xa1, 0xc8, 0x8d, 0xb1, 0xc0, 0xe8, 0xe0, 0x10, 0xd0, 0xf1, 0x8d, 0x59, 0xc0, 0x60, 0xad, 0xfb,
    0x07, 0x29, 0x08, 0xf0, 0x09, 0x20, 0x93, 0xfe, 0x20, 0x22, 0xfc, 0x20, 0x89, 0xfe, 0x68, 0xa8,
    0x68, 0xaa, 0x68, 0x60, 0x20, 0xd1, 0xc8, 0xe6, 0x4e, 0xd0, 0x02, 0xe6, 0x4f, 0xad, 0x00, 0xc0,
    0x10, 0xf5, 0x20, 0x5c, 0xc8, 0x90, 0xf0, 0x2c, 0x10, 0xc0, 0x18, 0x60, 0xc9, 0x8b, 0xd0, 0x02,
    0xa9, 0xdb, 0xc9, 0x81, 0xd0, 0x0a, 0xad, 0xfb, 0x07, 0x49, 0x40, 0x8d, 0xfb, 0x07, 0xb0, 0xe7,
    0x48, 0xad, 0xfb, 0x07, 0x0a, 0x0a, 0x68, 0x90, 0x1f, 0xc9, 0xb0, 0x90, 0x1b, 0x2c, 0x63, 0xc0,
    0x30, 0x14, 0xc9, 0xb0, 0xf0, 0x0e, 0xc9, 0xc0, 0xd0, 0x02, 0xa9, 0xd0, 0xc9, 0xdb, 0x90, 0x08,
    0x29, 0xcf, 0xd0, 0x04, 0xa9, 0xdd, 0x09, 0x20, 0x48, 0x29, 0x7f, 0x8d, 0x7b, 0x06, 0x68, 0x38,
    0x60, 0x7b, 0x50, 0x5e, 0x29, 0x1b, 0x08, 0x18, 0x19, 0x00, 0x08, 0xe0, 0x08, 0x00, 0x00, 0x00,
    0x00, 0x8d, 0x7b, 0x06, 0xa5, 0x25, 0xcd, 0xfb, 0x05, 0xf0, 0x06, 0x8d, 0xfb, 0x05, 0x20, 0x04,
    0xca, 0xa5, 0x24, 0xcd, 0x7b, 0x05, 0x90, 0x03, 0x8d, 0x7b, 0x05, 0xad, 0x7b, 0x06, 0x20, 0x89,
    0xca, 0xa9, 0x0f, 0x8d, 0xb0, 0xc0, 0xad, 0x7b, 0x05, 0xc9, 0x50, 0xb0, 0x13, 0x6d, 0x7b, 0x04,
    0x8d, 0xb1, 0xc0, 0xa9, 0x0e, 0x8d, 0xb0, 0xc0, 0xa9, 0x00, 0x6d, 0xfb, 0x04, 0x8d, 0xb1, 0xc0,
    0x60, 0x49, 0xc0, 0xc9, 0x08, 0xb0, 0x1d, 0xa8, 0xa9, 0xc9, 0x48, 0xb9, 0xf2, 0xcb, 0x48, 0x60,
    0xea, 0xac, 0x7b, 0x05, 0xa9, 0xa0, 0x20, 0x71, 0xca, 0xc8, 0xc0, 0x50, 0x90, 0xf8, 0x60, 0xa9,
    0x34, 0x8d, 0x7b, 0x07, 0x60, 0xa9, 0x32, 0xd0, 0xf8, 0xa0, 0xc0, 0xa2, 0x80, 0xca, 0xd0, 0xfd,
    0xad, 0x30, 0xc0, 0x88, 0xd0, 0xf5, 0x60, 0xac, 0x7b, 0x05, 0xc0, 0x50, 0x90, 0x05, 0x48, 0x20,
    0xb0, 0xc9, 0x68, 0xac, 0x7b, 0x05, 0x20, 0x71, 0xca, 0xee, 0x7b, 0x05, 0x2c, 0x78, 0x04, 0x10,
    0x07, 0xad, 0x7b, 0x05, 0xc9, 0x50, 0xb0, 0x68, 0x60, 0xac, 0x7b, 0x05, 0xad, 0xfb, 0x05, 0x48,
    0x20, 0x07, 0xca, 0x20, 0x04, 0xc9, 0xa0, 0x00, 0x68, 0x69, 0x00, 0xc9, 0x18, 0x90, 0xf0, 0xb0,
    0x23, 0x20, 0x67, 0xc9, 0x98, 0xf0, 0xe8, 0xa9, 0x00, 0x8d, 0x7b, 0x05, 0x8d, 0xfb, 0x05, 0xa8,
    0xf0, 0x12, 0xce, 0x7b, 0x05, 0x10, 0x9d, 0xa9, 0x4f, 0x8d, 0x7b, 0x05, 0xad, 0xfb, 0x05, 0xf0,
    0x93, 0xce, 0xfb, 0x05, 0x4c, 0x04, 0xca, 0xa9, 0x30, 0x8d, 0x7b, 0x07, 0x68, 0x09, 0x80, 0xc9,
    0xb1, 0xd0, 0x67, 0xa9, 0x08, 0x8d, 0x58, 0xc0, 0xd0, 0x5b, 0xc9, 0xb2, 0xd0, 0x51, 0xa9, 0xfe,
    0x2d, 0xfb, 0x07, 0x8d, 0xfb, 0x07, 0x60, 0x8d, 0x7b, 0x06, 0x4e, 0x78, 0x04, 0x4c, 0xcb, 0xc8,
    0x20, 0x27, 0xca, 0xee, 0xfb, 0x05, 0xad, 0xfb, 0x05, 0xc9, 0x18, 0x90, 0x4a, 0xce, 0xfb, 0x05,
    0xad, 0xfb, 0x06, 0x69, 0x04, 0x29, 0x7f, 0x8d, 0xfb, 0x06, 0x20, 0x12, 0xca, 0xa9, 0x0d, 0x8d,
    0xb0, 0xc0, 0xad, 0x7b, 0x04, 0x8d, 0xb1, 0xc0, 0xa9, 0x0c, 0x8d, 0xb0, 0xc0, 0xad, 0xfb, 0x04,
    0x8d, 0xb1, 0xc0, 0xa9, 0x17, 0x20, 0x07, 0xca, 0xa0, 0x00, 0x20, 0x04, 0xc9, 0xb0, 0x95, 0xc9,
    0xb3, 0xd0, 0x0e, 0xa9, 0x01, 0x0d, 0xfb, 0x07, 0xd0, 0xa9, 0xc9, 0xb0, 0xd0, 0x9c, 0x4c, 0x09,
    0xc8, 0x4c, 0x27, 0xc9, 0xad, 0xfb, 0x05, 0x8d, 0xf8, 0x04, 0x0a, 0x0a, 0x6d, 0xf8, 0x04, 0x6d,
    0xfb, 0x06, 0x48, 0x4a, 0x4a, 0x4a, 0x4a, 0x8d, 0xfb, 0x04, 0x68, 0x0a, 0x0a, 0x0a, 0x0a, 0x8d,
    0x7b, 0x04, 0x60, 0xc9, 0x0d, 0xd0, 0x06, 0xa9, 0x00, 0x8d, 0x7b, 0x05, 0x60, 0x09, 0x80, 0xc9,
    0xa0, 0xb0, 0xce, 0xc9, 0x87, 0x90, 0x08, 0xa8, 0xa9, 0xc9, 0x48, 0xb9, 0xb9, 0xc9, 0x48, 0x60,
    0x18, 0x71, 0x13, 0xb2, 0x48, 0x60, 0xaf, 0x9d, 0xf2, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13,
    0x13, 0x13, 0x66, 0x0e, 0x13, 0x38, 0x00, 0x14, 0x7b, 0x18, 0x98, 0x6d, 0x7b, 0x04, 0x48, 0xa9,
    0x00, 0x6d, 0xfb, 0x04, 0x48, 0x0a, 0x29, 0x0c, 0xaa, 0xbd, 0xb0, 0xc0, 0x68, 0x4a, 0x68, 0xaa,
    0x60, 0x0a, 0x48, 0xad, 0xfb, 0x07, 0x4a, 0x68, 0x6a, 0x48, 0x20, 0x59, 0xca, 0x68, 0xb0, 0x05,
    0x9d, 0x00, 0xcc, 0x90, 0x03, 0x9d, 0x00, 0xcd, 0x60, 0x48, 0xa9, 0xf7, 0x20, 0xa0, 0xc9, 0x8d,
    0x59, 0xc0, 0xad, 0x7b, 0x07, 0x29, 0x07, 0xd0, 0x04, 0x68, 0x4c, 0x23, 0xca, 0x29, 0x04, 0xf0,
    0x03, 0x4c, 0x87, 0xc9, 0x68, 0x38, 0xe9, 0x20, 0x29, 0x7f, 0x48, 0xce, 0x7b, 0x07, 0xad, 0x7b,
    0x07, 0x29, 0x03, 0xd0, 0x15, 0x68, 0xc9, 0x18, 0xb0, 0x03, 0x8d, 0xfb, 0x05, 0xad, 0xf8, 0x05,
    0xc9, 0x50, 0xb0, 0x03, 0x8d, 0x7b, 0x05, 0x4c, 0x04, 0xca, 0x68, 0x8d, 0xf8, 0x05, 0x60, 0xad,
    0x00, 0xc0, 0xc9, 0x93, 0xd0, 0x0f, 0x2c, 0x10, 0xc0, 0xad, 0x00, 0xc0, 0x10, 0xfb, 0xc9, 0x83,
    0xf0, 0x03, 0x2c, 0x10, 0xc0, 0x60, 0xa8, 0xb9, 0x31, 0xcb, 0x20, 0xf1, 0xc8, 0x20, 0x44, 0xc8,
    0xc9, 0xce, 0xb0, 0x08, 0xc9, 0xc9, 0x90, 0x04, 0xc9, 0xcc, 0xd0, 0xea, 0x4c, 0xf1, 0xc8, 0xea,
    0x2c, 0xcb, 0xff, 0x70, 0x31, 0x38, 0x90, 0x18, 0xb8, 0x50, 0x2b, 0x01, 0x82, 0x11, 0x14, 0x1c,
    0x22, 0x4c, 0x00, 0xc8, 0x20, 0x44, 0xc8, 0x29, 0x7f, 0xa2, 0x00, 0x60, 0x20, 0xa7, 0xc9, 0xa2,
    0x00, 0x60, 0xc9, 0x00, 0xf0, 0x09, 0xad, 0x00, 0xc0, 0x0a, 0x90, 0x03, 0x20, 0x5c, 0xc8, 0xa2,
    0x00, 0x60, 0x91, 0x28, 0x38, 0xb8, 0x8d, 0xff, 0xcf, 0x48, 0x85, 0x35, 0x8a, 0x48, 0x98, 0x48,
    0xa5, 0x35, 0x86, 0x35, 0xa2, 0xc3, 0x8e, 0x78, 0x04, 0x48, 0x50, 0x10, 0xa9, 0x32, 0x85, 0x38,
    0x86, 0x39, 0xa9, 0x07, 0x85, 0x36, 0x86, 0x37, 0x20, 0x00, 0xc8, 0x18, 0x90, 0x6f, 0x68, 0xa4,
    0x35, 0xf0, 0x1f, 0x88, 0xad, 0x78, 0x06, 0xc9, 0x88, 0xf0, 0x17, 0xd9, 0x00, 0x02, 0xf0, 0x12,
    0x49, 0x20, 0xd9, 0x00, 0x02, 0xd0, 0x3b, 0xad, 0x78, 0x06, 0x99, 0x00, 0x02, 0xb0, 0x03, 0x20,
    0xed, 0xca, 0xa9, 0x80, 0x20, 0xf5, 0xc9, 0x20, 0x44, 0xc8, 0xc9, 0x9b, 0xf0, 0xf1, 0xc9, 0x8d,
    0xd0, 0x05, 0x48, 0x20, 0x01, 0xc9, 0x68, 0xc9, 0x95, 0xd0, 0x12, 0xac, 0x7b, 0x05, 0x20, 0x59,
    0xca, 0xb0, 0x05, 0xbd, 0x00, 0xcc, 0x90, 0x03, 0xbd, 0x00, 0xcd, 0x09, 0x80, 0x8d, 0x78, 0x06,
    0xd0, 0x08, 0x20, 0x44, 0xc8, 0xa0, 0x00, 0x8c, 0x78, 0x06, 0xba, 0xe8, 0xe8, 0xe8, 0x9d, 0x00,
    0x01, 0xa9, 0x00, 0x85, 0x24, 0xad, 0xfb, 0x05, 0x85, 0x25, 0x4c, 0x2e, 0xc8, 0x68, 0xac, 0xfb,
    0x07, 0x10, 0x08, 0xac, 0x78, 0x06, 0xc0, 0xe0, 0x90, 0x01, 0x98, 0x20, 0xb1, 0xc8, 0x20, 0xcf,
    0xca, 0xa9, 0x7f, 0x20, 0xa0, 0xc9, 0xad, 0x7b, 0x05, 0xe9, 0x47, 0x90, 0xd4, 0x69, 0x1f, 0x18,
    0x90, 0xd1, 0x60, 0x38, 0x71, 0xb2, 0x7b, 0x00, 0x48, 0x66, 0xc4, 0xc2, 0xc1, 0xff, 0xc3, 0xea,
];

const VIDEO_ROM: [u8; 0x800] = [
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xe0, 0x90, 0xe0, 0x9e, 0xf0, 0x0c, 0x02, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x90, 0x90, 0xf0, 0x90, 0xbe, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x80, 0x80, 0x9e, 0xf0, 0x18, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x88, 0x88, 0x50, 0x20, 0x3e, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xf0, 0x80, 0xc0, 0x9e, 0x90, 0x18, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x70, 0x80, 0x80, 0x7c, 0x12, 0x1c, 0x14, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x70, 0x80, 0x60, 0x10, 0xec, 0x12, 0x12, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x70, 0x80, 0x60, 0x1e, 0xe4, 0x04, 0x04, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x08, 0x08, 0x08, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x00, 0x00, 0x00, 0x00, 0x0f, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0x0f, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x08, 0x08, 0x08, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x08, 0x08, 0x08, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0xf8, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x00, 0x00, 0x00, 0x00, 0xff, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x08, 0x08, 0x08, 0x08, 0xff, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x36, 0x36, 0x12, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x24, 0x24, 0x7e, 0x24, 0x7e, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x3e, 0x48, 0x3c, 0x12, 0x7c, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x62, 0x94, 0x68, 0x10, 0x2c, 0x52, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x20, 0x50, 0x50, 0x62, 0x94, 0x88, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x18, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0c, 0x10, 0x20, 0x20, 0x20, 0x10, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x30, 0x08, 0x04, 0x04, 0x04, 0x08, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x92, 0x54, 0x38, 0x54, 0x92, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x10, 0xfe, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x38, 0x44, 0x8a, 0x92, 0xa2, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x38, 0x08, 0x08, 0x08, 0x08, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x02, 0x1c, 0x20, 0x40, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7e, 0x04, 0x08, 0x1c, 0x02, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x04, 0x0c, 0x14, 0x24, 0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7e, 0x40, 0x7c, 0x02, 0x02, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1e, 0x20, 0x40, 0x7c, 0x42, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7e, 0x02, 0x04, 0x08, 0x10, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x42, 0x3c, 0x42, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x42, 0x3e, 0x02, 0x04, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x06, 0x18, 0x60, 0x18, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7e, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x60, 0x18, 0x06, 0x18, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x02, 0x0c, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x9a, 0xaa, 0x94, 0x40, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x24, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7c, 0x42, 0x42, 0x7c, 0x42, 0x42, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1c, 0x22, 0x40, 0x40, 0x40, 0x22, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x78, 0x44, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7e, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7e, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1c, 0x22, 0x40, 0x4e, 0x42, 0x22, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x42, 0x42, 0x42, 0x7e, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1c, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0e, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x42, 0x44, 0x48, 0x50, 0x68, 0x44, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x82, 0xc6, 0xaa, 0x92, 0x82, 0x82, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x42, 0x62, 0x52, 0x4a, 0x46, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x38, 0x44, 0x82, 0x82, 0x82, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7c, 0x42, 0x42, 0x7c, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x38, 0x44, 0x82, 0x82, 0x8a, 0x44, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x7c, 0x42, 0x42, 0x7c, 0x48, 0x44, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x42, 0x40, 0x3c, 0x02, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xfe, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x82, 0x82, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x82, 0x82, 0x82, 0x82, 0x92, 0xaa, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x82, 0x44, 0x28, 0x10, 0x28, 0x44, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x82, 0x44, 0x28, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xfe, 0x04, 0x08, 0x10, 0x20, 0x40, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3e, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3e, 0x06, 0x06, 0x06, 0x06, 0x06, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x1c, 0x2a, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x18, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xf8, 0x04, 0x7c, 0x84, 0x7a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x40, 0x40, 0x7c, 0x42, 0x42, 0x42, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3c, 0x42, 0x40, 0x40, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x02, 0x02, 0x3e, 0x42, 0x42, 0x42, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3c, 0x42, 0x7e, 0x40, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x1c, 0x22, 0x20, 0x78, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x02, 0x3c, 0x42, 0x42, 0x3e, 0x02, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x40, 0x40, 0x5c, 0x62, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x24, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x40, 0x40, 0x46, 0x58, 0x60, 0x58, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0xec, 0x92, 0x92, 0x92, 0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x5c, 0x22, 0x22, 0x22, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3c, 0x42, 0x42, 0x42, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7c, 0x42, 0x42, 0x42, 0x7c, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3e, 0x42, 0x42, 0x42, 0x3e, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x5c, 0x62, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x3e, 0x40, 0x3c, 0x02, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x10, 0x3e, 0x10, 0x10, 0x10, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x82, 0x82, 0x44, 0x28, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x82, 0x82, 0x92, 0xaa, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x42, 0x24, 0x18, 0x24, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x82, 0x82, 0x44, 0x28, 0x10, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x7e, 0x04, 0x18, 0x20, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x0c, 0x10, 0x08, 0x30, 0x08, 0x10, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x08, 0x08, 0x08, 0x00, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x30, 0x08, 0x10, 0x0c, 0x10, 0x08, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x60, 0x92, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x24, 0x48, 0x92, 0x24, 0x48, 0x92, 0x24, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
];

const BLINK_PERIOD_FAST: usize = 267;
const BLINK_PERIOD_SLOW: usize = 533;

//const CURSOR_UPPER: usize = 0x0a;
//const CURSOR_LOWER: usize = 0x0b;
const CURSOR_START: usize = 0x0a;
const CURSOR_END: usize = 0x0b;
const STARTPOS_HI: usize = 0x0c;
const STARTPOS_LO: usize = 0x0d;
const CURSOR_HI: usize = 0x0e;
const CURSOR_LO: usize = 0x0f;

#[derive(Debug, Eq, PartialEq)]
#[cfg_attr(feature = "serde_support", derive(Serialize, Deserialize))]
pub struct Videoterm {
    bank: u8,
    register: u8,
    mc6485_regs: Vec<u8>,
    vram: Vec<u8>,
    blink: bool,
    blink_time: u64,
    cursor_pos: u16,
    dirty_lines: Vec<bool>,
}

#[derive(Debug, PartialEq)]
enum CursorMode {
    Fixed,
    None,
    Fast,
    Slow,
}

impl Videoterm {
    fn get_start_pos(&self) -> u16 {
        ((self.mc6485_regs[STARTPOS_HI] as u16) << 8) | self.mc6485_regs[STARTPOS_LO] as u16
    }

    fn get_cursor_pos(&self) -> u16 {
        ((self.mc6485_regs[CURSOR_HI] as u16) << 8) | self.mc6485_regs[CURSOR_LO] as u16
    }

    fn get_cursor_start(&self) -> u8 {
        self.mc6485_regs[CURSOR_START] & 0x1f
    }

    fn get_cursor_end(&self) -> u8 {
        self.mc6485_regs[CURSOR_END] & 0x1f
    }

    fn get_cursor_mode(&self) -> CursorMode {
        let cursor_mode = (self.mc6485_regs[CURSOR_START] >> 5) & 0x3;
        match cursor_mode {
            0 => CursorMode::Fixed,
            1 => CursorMode::None,
            2 => CursorMode::Fast,
            3 => CursorMode::Slow,
            _ => {
                unreachable!("Cursor mode value is from 0 to 3 only")
            }
        }
    }

    fn draw_char(&mut self, video: &mut Video, addr: u16, value: u8, cursor: bool) {
        let start_pos = self.get_start_pos();
        let start_addr = (0x800 + addr - start_pos) & 0x7ff;
        let row = (start_addr / 80) as usize;
        let col = (start_addr % 80) as usize;
        let x = col * 7;
        let y = row * 8;

        if row >= 24 {
            return;
        }

        let rom_index = (value as usize) << 4;
        let inverse = rom_index >= 0x800;
        let color_on = video.get_mono_color();
        let color_off = crate::video::COLOR_BLACK;
        let cursor_start = self.get_cursor_start() as usize;
        let cursor_end = self.get_cursor_end() as usize;

        let mut char_rows = [0u8; 9];
        for j in 0..9 {
            let pixels = VIDEO_ROM[(rom_index + j) % 0x800];
            char_rows[j] = if inverse {
                if !cursor || j >= cursor_start && j <= cursor_end {
                    !pixels
                } else {
                    pixels
                }
            } else {
                pixels
            };
        }

        let scanline = video.get_scanline();
        for j in 0..16 {
            let y_screen = y * 2 + j;
            let src_row = ((j + 1) * 8 / 16).min(8);
            let src_pixels = char_rows[src_row];
            for i in 0..7 {
                let bit_set = (src_pixels & (0x80 >> i)) != 0;
                let base_color = if bit_set { color_on } else { color_off };
                let final_color = if scanline && j % 2 != 0 {
                    [base_color[0] / 2, base_color[1] / 2, base_color[2] / 2]
                } else {
                    base_color
                };
                video.set_pixel(x + i, y_screen, final_color);
            }
        }
    }

    fn draw_cursor(&mut self, video: &mut Video) {
        let current_time_ms = SystemTime::now()
            .duration_since(SystemTime::UNIX_EPOCH)
            .unwrap_or(std::time::Duration::ZERO)
            .as_millis() as u64;
        let elapsed = current_time_ms.saturating_sub(self.blink_time);
        let cursor_pos = self.get_cursor_pos();

        let cursor_mode = self.get_cursor_mode();

        if cursor_mode == CursorMode::Fast && elapsed > BLINK_PERIOD_FAST as u64 {
            self.blink = !self.blink;
            self.blink_time = current_time_ms;
        }

        if cursor_mode == CursorMode::Slow && elapsed > BLINK_PERIOD_SLOW as u64 {
            self.blink = !self.blink;
            self.blink_time = current_time_ms;
        }

        let offset = if cursor_mode == CursorMode::Fixed || self.blink {
            0x80
        } else {
            0x0
        };

        if cursor_mode != CursorMode::None {
            if self.cursor_pos != cursor_pos {
                let prev_value = self.vram[(self.cursor_pos & 0x7ff) as usize];
                self.draw_char(video, self.cursor_pos, prev_value, false);
                self.cursor_pos = cursor_pos
            }
            let value = ((self.vram[(cursor_pos & 0x7ff) as usize] as u16 + offset) & 0xff) as u8;
            self.draw_char(video, cursor_pos, value, true);
        }
    }

    pub fn invalidate_video(&mut self) {
        for i in 0..24 {
            self.dirty_lines[i] = true
        }
    }

    pub fn refresh(&mut self, video: &mut Video) {
        for line in 0..24 {
            if self.dirty_lines[line] {
                self.dirty_lines[line] = false;
                let start_pos = self.get_start_pos();
                let address = start_pos + (line as u16) * 80;
                for addr in address..address + 80 {
                    let value = self.vram[addr as usize & 0x7ff];
                    self.draw_char(video, addr, value, false)
                }
            }
        }
        self.draw_cursor(video);
    }
}

impl Default for Videoterm {
    fn default() -> Self {
        Videoterm {
            bank: 0,
            register: 0,
            mc6485_regs: vec![0; 18],
            vram: vec![0; 0x800],
            blink: false,
            blink_time: (SystemTime::now()
                .duration_since(SystemTime::UNIX_EPOCH)
                .unwrap_or(std::time::Duration::ZERO)
                .as_millis()) as u64,
            dirty_lines: vec![false; 24],
            cursor_pos: 0,
        }
    }
}

impl Card for Videoterm {
    fn rom_access(&mut self, addr: u16, value: u8, write_flag: bool) -> u8 {
        let mut return_value = value;
        if write_flag {
            if (0xcc00..0xce00).contains(&addr) {
                let page = (addr >> 8) & 0x01;
                let address = ((page + self.bank as u16 * 2) * 256) | (addr & 0xff);
                self.vram[address as usize] = value;
                let start_pos = self.get_start_pos();
                let v_address = (0x800 + address - start_pos) & 0x7ff;
                let dirty_line = v_address / 80;
                if dirty_line < 24 {
                    self.dirty_lines[dirty_line as usize] = true
                }
            }
        } else if addr < 0xcc00 {
            let page = ((addr >> 8) & 0x03) << 8;
            return_value = ROM[(page + (addr & 0xff)) as usize];
        } else if addr < 0xce00 {
            let page = (addr >> 8) & 0x01;
            let address = ((page + self.bank as u16 * 2) * 256) | (addr & 0xff);
            return_value = self.vram[address as usize];
        }

        return_value
    }

    fn io_access(
        &mut self,
        _mem: &mut Mmu,
        _video: &mut Video,
        addr: u16,
        value: u8,
        write_flag: bool,
    ) -> u8 {
        let slot = (((addr & 0x00ff) - 0x0080) >> 4) as usize;
        let io_addr = ((addr & 0x00ff) - ((slot as u16) << 4)) as u8;
        let mut return_value = value;
        match io_addr & 0x81 {
            0x80 => {
                if write_flag {
                    self.register = value;
                } else {
                    return_value = self.register;
                }
            }

            0x81 => {
                if write_flag {
                    if self.register < self.mc6485_regs.len() as u8 {
                        self.mc6485_regs[self.register as usize] = value;

                        if self.register == STARTPOS_HI as u8 || self.register == STARTPOS_LO as u8
                        {
                            self.invalidate_video();
                        }
                    }
                } else if [14, 15, 17].contains(&self.register) {
                    return_value = self.mc6485_regs[self.register as usize];
                }
            }
            _ => {}
        }

        self.bank = (io_addr & 0xc) >> 2;

        return_value
    }
}
